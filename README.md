# Esteban's Dotfiles Backup and Restore Scripts

This repository contains scripts and configuration files to streamline the setup and restoration of a Fedora Linux environment.

The scripts on this repository are highly opinionated and tailored to my personal preferences and workflow. They are designed to automate the backup of critical configurations and the restoration of a Fedora system, including GNOME settings, package installations, and dotfiles.

They aren't meant to be a one-size-fits-all solution, but rather a starting point for anyone looking to automate their Fedora setup process. Feel free to adapt them to your own needs.

## Structure

-   **`home/`**: This directory mirrors the structure of your actual `$HOME` directory. Files and folders placed here (e.g., `home/.zshrc`, `home/.config/nvim/`) will be copied to their corresponding locations in your `$HOME` using `rsync` during the restore process.
-   **`config/`**: This directory stores generated backup data from `backup.sh` and manually curated lists for `restore.sh`. Besides `backup_config.sh` (detailed separately below), its key files include:
    -   `dnf_packages.txt`: Manually curated list of DNF packages and groups for `restore.sh`.
    -   `flatpak_apps.txt`: List of user and system Flatpak applications (generated by `backup.sh`, used by `restore.sh`).
    -   `gnome-settings.dconf`: GNOME desktop settings (generated by `backup.sh`, used by `restore.sh`).
    -   `brew_packages.txt`: List of Homebrew packages in Brewfile format (generated by `backup.sh`, used by `restore.sh`).
    -   `appimage_list.txt`: List of AppImage file names found in `~/Applications` (generated by `backup.sh`, `restore.sh` reminds the user about these).
-   **`backup.sh`**: Script to populate `home/` with your critical dotfiles (defined in `config/backup_config.sh`) and `config/` with system configurations.
-   **`config/backup_config.sh`**: Configuration file for `backup.sh`, listing which files/directories from `$HOME` should be copied to `home/`.
-   **`restore.sh`**: Script to restore system configurations from `config/`, copy the contents of `home/` into your actual `$HOME` directory using `rsync`, and perform further system setup, software installation, and configurations.

## Purpose

The main goals of this dotfiles repository are:
-   **Backup Critical Configurations**: Save essential system and application settings.
-   **Automate Reinstallation**: Speed up the process of setting up a new Fedora installation or recovering an existing one.
-   **Version Control**: Keep track of changes to configurations over time.
-   **Consistency**: Ensure a consistent development environment across reinstallations.

## Target System

Primarily target: **Fedora Linux 42 (Workstation Edition) x86_64** (or newer compatible versions). With latest GNOME as desktop environment.

## Scripts

All scripts are designed to be run from the root of this repository.

### `backup.sh`

-   **Purpose**:
    1.  Copies critical dotfiles and directories from your `$HOME` (as defined in `config/backup_config.sh`) into the `home/` directory of this repository, maintaining their structure.
    2.  Backs up system configurations (GNOME settings, package lists) to the `config/` subdirectory.
-   **What it backs up to `home/` (contents to be copied to `$HOME` during restore, based on `config/backup_config.sh`)**:
    -   User-defined files and directories (e.g., `.zshrc`, `.gitconfig`, `.ssh/`, `.config/nvim`).
-   **What it backs up to `config/`**:
    -   GNOME settings (to `config/gnome-settings.dconf`)
    -   List of user and system-installed Flatpak applications (to `config/flatpak_apps.txt`)
    -   Brew packages (to `config/brew_packages.txt`)
-   **Usage**:
    ```bash
    ./backup.sh
    ```
-   **Output**:
    -   Dotfiles (defined in `config/backup_config.sh`) are copied to the `home/` directory.
    -   System configuration lists are stored in `config/`.

### `restore.sh`

-   **Purpose**:
    1.  Restores system configurations (GNOME settings, DNF/Flatpak/Brew packages) from the files in `config/`.
    2.  Copies files and directories from this repository's `home/` directory to their corresponding locations in your actual `$HOME` directory using `rsync`. This will overwrite existing files in the target if they are different.
    3.  Performs extensive post-installation setup tasks, including software installation and system configuration.
-   **What it restores/reinstalls (from `config/`)**:
    -   GNOME settings (from `config/gnome-settings.dconf`)
    -   DNF packages and groups (based on `config/dnf_packages.txt`)
    -   Flatpak applications (from `config/flatpak_apps.txt`)
    -   Brew packages (from `config/brew_packages.txt`)
-   **What it copies (from `dotfiles/home/` to `$HOME/` using rsync)**:
    -   All files and directories found directly within the `dotfiles/home/` directory (e.g., `.zshrc`, `.gitconfig`, `.ssh/`, `.config/`) will be copied.
    -   The script will ask for confirmation before copying files, warning that this will overwrite existing files in the target if they are different.
-   **Prerequisites**:
    1.  Clone this dotfiles repository to your home directory (e.g., `~/dotfiles`).
    2.  Ensure essential tools like `git`, `dnf`, `flatpak`, and `brew` are installed on the new system.
    3.  For Brew, you'll need to install Homebrew itself first if it's not present.
-   **Usage**:
    ```bash
    ./restore.sh
    ```
    The script will prompt for confirmation before applying system changes.
-   **Next Step**: After running `restore.sh`, review its output. Most setup tasks are now included.

## Additional Script: `luks-enroll-tpm2.sh`

This repository also includes `luks-enroll-tpm2.sh`, a helper script to automate the process of enrolling a TPM2 device for LUKS disk encryption on Fedora systems. It guides you through:
- Verifying SecureBoot status
- Detecting your TPM2 device and LUKS partition
- Enrolling the TPM2 device as an unlock method for your LUKS volume
- Updating GRUB and dracut configuration for TPM2-based unlocking
- Verifying the configuration at each step

**Warning:**
- This script is provided **as is**, with **no warranty** and **no guarantee** of fitness for any particular purpose.
- It is intended for advanced users who understand the risks of modifying disk encryption and bootloader settings.
- Always back up your data before making changes to disk encryption or boot configuration.

## Manual Configuration, PikaBackup

These scripts automate many parts of the setup, but some steps still require manual attention:

1.  **PikaBackup (or similar)**:
    -   It is **highly recommended** to use a full backup solution like PikaBackup for your entire `/home` directory. This is crucial for restoring personal files, documents, and application data not explicitly managed by these dotfiles (i.e., not copied to `dotfiles/home/` or covered by package lists).
    -   Restore from PikaBackup *before* running `restore.sh` if you intend to recover your complete home directory.

2.  **Managing Dotfiles in `dotfiles/home/` via `config/backup_config.sh`**:
    -   The `backup.sh` script copies files and directories into `dotfiles/home/` based on the `DOTFILES_TO_COPY_DIRECTLY` array in `config/backup_config.sh`.
    -   To manage which dotfiles are backed up to be copied to `$HOME` during restore:
        1.  Edit the `config/backup_config.sh` file.
        2.  Add or remove paths (relative to `$HOME`) from the `DOTFILES_TO_COPY_DIRECTLY` array.
        3.  Run `backup.sh` to update the contents of `dotfiles/home/`.
        4.  Commit changes to `config/backup_config.sh` and the updated `dotfiles/home/` directory to your Git repository.
    -   The `restore.sh` script will then automatically find and copy the contents of `dotfiles/home/` using `rsync` during its run.
    -   **Security Note for SSH keys**: If you include `.ssh` in `config/backup_config.sh`, the `backup.sh` script will copy your `~/.ssh` directory to `dotfiles/home/.ssh/`. Be extremely cautious and ensure this dotfiles repository is kept private if you commit these keys. The `restore.sh` script includes a function (`setup_ssh_permissions`) to help set correct permissions on `~/.ssh/` after it has been copied.

# Happy Paths

## Backup

0. Have this repository cloned to your home directory (e.g., `~/dotfiles`).
1. Have PikaBackup (or a similar backup solution) installed and configured to back up your entire `/home` directory. This is crucial for restoring personal files, documents, and application data not explicitly managed by these dotfiles.
2. Run `backup.sh` to populate the `home/` and `config/` directories with your dotfiles and system configurations.
3. Review the files in `home/` and `config/` to ensure they contain everything you want to back up.
4. Store the repository and the contents of `home/` and `config/` in a safe place (e.g., a flash drive, a local NAS, etc.).

## Restore

0. Have a fresh Fedora installation ready.
1. Restore this `~/dotfiles` repository (from your flash drive, local NAS, etc.) to your home directory (e.g., `~/dotfiles`).
2. Restore your personal files from PikaBackup (or your chosen backup solution) to your home directory. This has to be done manually.
3. Run `restore.sh` to:
    - Restore system configurations from `config/`.
    - Copy the contents of `home/` into your actual `$HOME` directory using `rsync`.
    - Install DNF packages, Flatpak applications, and Homebrew packages as defined in the configuration files.
4. Review the output of `restore.sh` to ensure all configurations and installations were successful.
5. Log out and log back in to apply GNOME settings and other desktop environment changes.

## Contributing

This is a personal dotfiles repository, but suggestions or improvements are welcome via issues or pull requests if you happen to find this repository.

# License

This project is licensed under the MIT License. See the [LICENSE](./LICENSE.md) file for details.
